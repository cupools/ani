{"version":3,"file":"velocity-component.js","sources":["../src/velocity-component.js"],"sourcesContent":["import { h, Component } from 'preact'\nimport Velocity from 'velocity-animate'\nimport 'velocity-animate/velocity.ui.min'\nimport { isEqual } from 'lodash'\n\nconsole.log(Velocity.RegisterEffect)\n\nclass VelocityComponent extends Component {\n  componentDidMount() {\n    this.runAnimation()\n\n    if (!this.props.runOnMount) {\n      // should work with default props\n      // this._finishAnimation()\n    }\n  }\n\n  componentWillUnmount() {\n    this._stopAnimation()\n    this._clearVelocityCache(this._getDOMTarget())\n  }\n\n  componentWillUpdate(newProps) {\n    if (!isEqual(newProps.keyframes, this.props.keyframes)) {\n      this._stopAnimation()\n      this._scheduleAnimation()\n    }\n  }\n\n  runAnimation(config = {}) {\n    if (!this.props.keyframes) {\n      return\n    }\n\n    const dom = this._getDOMTarget()\n    this._shouldRunAnimation = false\n\n    if (config.stop) {\n      Velocity(dom, 'stop', true)\n    } else if (config.finish) {\n      Velocity(dom, 'finishAll', true)\n    }\n\n    const { keyframes, ...ani } = this.props\n\n    // FIXME, origin status\n    Velocity(this._getDOMTarget(), ani, { duration: 0 })\n\n    keyframes.forEach(keyframe => {\n      const { duration = 0, delay = 0, easing = 'linear', loop = 0, complete = null, ...props } = keyframe\n\n      if (keyframe.keyframes) {\n        // Velocity Effect calls\n        const __aniName = `transition${Math.random().toString().slice(2, 10)}`\n        Velocity.RegisterEffect(__aniName, {\n          calls: keyframe.keyframes.map(item => [item, item.durationPercentage]),\n          loop\n        })\n        Velocity(this._getDOMTarget(), __aniName, { duration, delay, easing, loop, complete })\n      } else {\n        // single transform\n        Velocity(this._getDOMTarget(), props, { duration, delay, easing, loop, complete })\n      }\n    })\n  }\n\n  _scheduleAnimation() {\n    if (this._shouldRunAnimation) {\n      return\n    }\n\n    this._shouldRunAnimation = true\n    setTimeout(this.runAnimation.bind(this), 0)\n  }\n\n  _getDOMTarget() {\n    return this.base\n  }\n\n  _finishAnimation() {\n    Velocity(this._getDOMTarget(), 'finishAll', true)\n  }\n\n  _stopAnimation() {\n    Velocity(this._getDOMTarget(), 'stop', true)\n  }\n\n  _clearVelocityCache(target) {\n    if (target.length) {\n      target.forEach(this._clearVelocityCache)\n    } else {\n      Velocity.Utilities.removeData(target, ['velocity', 'fxqueue'])\n    }\n  }\n\n  render() {\n    return this.props.children.length ? this.props.children[0] : <span {...this.props}></span>\n  }\n\n  getDefaultProps() {\n    // maybe should work with preact-compat\n    return {\n      animation: null,\n      runOnMount: false\n    }\n  }\n}\n\nexport default VelocityComponent\n"],"names":["console","log","Velocity","RegisterEffect","VelocityComponent","componentDidMount","runAnimation","this","props","runOnMount","componentWillUnmount","_stopAnimation","_clearVelocityCache","_getDOMTarget","componentWillUpdate","newProps","isEqual","keyframes","_scheduleAnimation","config","dom","_shouldRunAnimation","stop","finish","ani","duration","forEach","keyframe","delay","easing","loop","complete","__aniName","Math","random","toString","slice","map","item","durationPercentage","_this2","bind","base","_finishAnimation","target","length","Utilities","removeData","render","children","h","getDefaultProps","Component"],"mappings":"knCAKAA,SAAQC,IAAIC,EAASC,mBAEfC,uGACJC,kCACOC,gBAEAC,KAAKC,MAAMC,wBAMlBC,qCACOC,sBACAC,oBAAoBL,KAAKM,8BAGhCC,6BAAoBC,GACbC,UAAQD,EAASE,UAAWV,KAAKC,MAAMS,kBACrCN,sBACAO,mCAITZ,mCAAaa,+DACNZ,KAAKC,MAAMS,cAIVG,GAAMb,KAAKM,qBACZQ,qBAAsB,EAEvBF,EAAOG,OACAF,EAAK,QAAQ,GACbD,EAAOI,UACPH,EAAK,aAAa,SAGCb,KAAKC,MAA3BS,IAAAA,UAAcO,uBAGbjB,KAAKM,gBAAiBW,GAAOC,SAAU,MAEtCC,QAAQ,kBAC4EC,EAApFF,SAAAA,aAAW,MAAyEE,EAAtEC,MAAAA,aAAQ,MAA8DD,EAA3DE,OAAAA,aAAS,aAAkDF,EAAxCG,KAAAA,aAAO,MAAiCH,EAA9BI,SAAAA,aAAW,OAASvB,IAAUmB,sDAExFA,EAASV,UAAW,IAEhBe,gBAAyBC,KAAKC,SAASC,WAAWC,MAAM,EAAG,MACxDjC,eAAe6B,SACfL,EAASV,UAAUoB,IAAI,mBAASC,EAAMA,EAAKC,iCAG3CC,EAAK3B,gBAAiBmB,GAAaP,WAAUG,QAAOC,SAAQC,OAAMC,oBAGlES,EAAK3B,gBAAiBL,GAASiB,WAAUG,QAAOC,SAAQC,OAAMC,6BAK7Eb,8BACMX,KAAKc,2BAIJA,qBAAsB,aAChBd,KAAKD,aAAamC,KAAKlC,MAAO,iBAG3CM,+BACSN,MAAKmC,kBAGdC,8BACWpC,KAAKM,gBAAiB,aAAa,gBAG9CF,4BACWJ,KAAKM,gBAAiB,QAAQ,gBAGzCD,6BAAoBgC,GACdA,EAAOC,SACFnB,QAAQnB,KAAKK,uBAEXkC,UAAUC,WAAWH,GAAS,WAAY,yBAIvDI,wBACSzC,MAAKC,MAAMyC,SAASJ,OAAStC,KAAKC,MAAMyC,SAAS,GAAKC,WAAU3C,KAAKC,oBAG9E2C,4CAGe,iBACC,OAhGcC"}